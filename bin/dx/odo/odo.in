#!/bin/dash
#
# odo executes programs that carry out Oracc commands.
# 
# The first argument is the directory in which to put the status file
# and any other outputs.  When called from osh/dx this is the tmpdir
# which has a session code; if odo is called directly (really only for
# testing) any directory can be used for this as long as it is
# writable. The special tmpdir '-' can be used in which case files are
# written to the environment TMPDIR or /tmp if TMPDIR is not set.
#
# The second argument is the project; if project is "." use oraccopt
# to find it from 00lib/config.xml
#
# The third argument is the base command to execute.
#
# For any command except 'init', odo looks for a script
# $user-COMMAND.sh; if not found, it looks for odo-COMMAND.sh. If
# neither of these scripts exists it is a bad command (which should be
# caught earlier by osh).
#
# The command script is then called with $user and $project as the
# first two arguments, and any additional arguments are also appended
# to the script invocation.
#

fail ()
{
    set_status error
    exit 1;
}

set_status ()
{
    if [ "$tmpdir" != "" ]; then
	if [ -d $tmpdir ]; then
	    echo $0 writing status $1 to $tmpdir/status
	    printf "$1" >$tmpdir/status;
	fi
    fi
}

exec 1>&2

echo $0 called with arguments $*

if [ "$1" = "-v" ]; then
    shift
    V="-v"
fi

if [ $# -lt 3 ]; then
    echo $0: not enough arguments--need at least TMPDIR PROJECT COMMAND. Stop.
    fail
fi

tmpdir=$1
if [ "$tmpdir" = "-" ]; then
  if [ "$TMPDIR" != "" ]; then
    tmpdir=$TMPDIR
  else
    tmpdir=/tmp
  fi
fi

if [ ! -d $tmpdir ]; then
    echo $0: $tmpdir is not a directory. Stop.
    fail
fi

shift

project=$1
if [ "$project" = "." ]; then
    if [ -r 00lib/config.xml ]; then
	project=`oraccopt`
    else
	echo $0: you can only use 'odo .' in a project directory. Stop.
	fail
    fi
fi

if [ "$project" != "" ]; then
    shift
    command=$1
    if [ "$command" != "" ]; then
	shift
	bin=@@ORACC_BUILDS@@/bin
	user=`/bin/echo -n $project | cut -d/ -f1`
	echo "$0: tmpdir=$tmpdir; user=$user; project=$project; command=$command"
	if [ $command = "init" ]; then
	    cd @@ORACC_BUILDS@@
	    if [ ! -r $user ]; then
		$bin/odo-cvs-checkout.sh $user $*
		if [ $? != 0 ]; then
		    echo $0: odo-checkout.sh $user $*: command failed with code $?.
		    fail
		else
		    set_status done
		fi
	    else
		echo $0: $user already exists. Stop.
		fail
	    fi
	else
	    projdir=@@ORACC_BUILDS@@/$project
	    if [ -d $projdir ]; then
		(cd $projdir
		 . $bin/odo-environment.sh
		 $bin/odo-cvs-refresh.sh $user $*
		 $bin/odo-dir-links.sh $project $V
		 $bin/odo-config.sh $project $V
		 if [ "$command" != "config" ]; then
		     uscript=$bin/${user}-${command}.sh
		     if [ -x $bin/$user-$command.sh ]; then
			 $uscript $user $project $*
		     else
			 script=$bin/odo-$command.sh
			 if [ -x $script ]; then
			     $script $user $project $*
			 else
			     echo "$0: no command $uscript or $script. Stop."
			 fi
		     fi
		 fi
		)
		set_status done
	    else
		echo $0: unknown project $project.  Do you need to run odo $project init? Stop.
		fail
	    fi
	fi
    else
	echo $0: empty command argument. Stop.
	fail
    fi
else
    echo $0: empty project argument. Stop.
    fail
fi
